#!/usr/bin/env bash
set -eo pipefail

app_root="$(cd "$(dirname "$0")/.." && pwd)"
cd "$app_root"

echo
echo "______            _ _                _   ______ _       "
echo "|  ___|          | | |              | |  | ___ (_)      "
echo "| |_ ___  ___  __| | |__   __ _  ___| | _| |_/ /_ _ __  "
echo "|  _/ _ \/ _ \/ _\` | '_ \ / _\` |/ __| |/ / ___ \ | '_ \ "
echo "| ||  __/  __/ (_| | |_) | (_| | (__|   <| |_/ / | | | |"
echo "\_| \___|\___|\__,_|_.__/ \__,_|\___|_|\_\____/|_|_| |_|"
echo

# Check Ruby version
required_ruby=$(cat .ruby-version | tr -d '[:space:]')
if command -v ruby &>/dev/null; then
  current_ruby=$(ruby -v | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
  if [ "$current_ruby" != "${required_ruby#ruby-}" ]; then
    echo "⚠ Ruby version mismatch"
    echo "  Required: ${required_ruby#ruby-}"
    echo "  Current:  $current_ruby"
    echo ""
    echo "  Consider using mise, rbenv, or asdf to install the correct version."
    echo "  https://mise.jdx.dev/ or https://github.com/rbenv/rbenv"
    echo ""
  fi
else
  echo "✗ Ruby not found. Please install Ruby ${required_ruby#ruby-}"
  echo "  https://mise.jdx.dev/ or https://github.com/rbenv/rbenv"
  exit 1
fi

# Install system dependencies
install_packages() {
  local packages=("$@")
  if command -v brew &>/dev/null; then
    local missing=()
    for pkg in "${packages[@]}"; do
      if ! brew list "$pkg" &>/dev/null; then
        missing+=("$pkg")
      fi
    done
    if [ ${#missing[@]} -gt 0 ]; then
      echo "▸ Installing packages: ${missing[*]}"
      brew install "${missing[@]}"
      echo
    fi
  elif command -v apt-get &>/dev/null; then
    echo "▸ Installing packages: ${packages[*]}"
    sudo apt-get update && sudo apt-get install -y "${packages[@]}"
    echo
  elif command -v pacman &>/dev/null; then
    echo "▸ Installing packages: ${packages[*]}"
    sudo pacman -S --noconfirm --needed "${packages[@]}"
    echo
  fi
}

# vips is required for image_processing gem
if ! command -v vips &>/dev/null; then
  echo "▸ vips not found (required for image processing)"
  if command -v brew &>/dev/null; then
    install_packages vips
  elif command -v apt-get &>/dev/null; then
    install_packages libvips-dev
  elif command -v pacman &>/dev/null; then
    install_packages libvips
  else
    echo "  Please install libvips manually: https://www.libvips.org/install.html"
    exit 1
  fi
fi

# Install Ruby dependencies
echo "▸ Installing Ruby dependencies"
bundle config set --local auto_install true
bundle check || bundle install
echo

# Prepare database
if [[ "$*" == *--reset* ]]; then
  echo "▸ Resetting database"
  bin/rails db:reset
else
  echo "▸ Preparing database"
  bin/rails db:prepare

  # Seed if database is empty (not in CI)
  if [ -z "$CI" ]; then
    has_data=$(bin/rails runner "print Account.any?" 2>/dev/null || echo "false")
    if [ "$has_data" != "true" ]; then
      echo
      echo "▸ Seeding database"
      bin/rails db:seed
    fi
  fi
fi
echo

# Clean up
echo "▸ Cleaning up logs and temp files"
bin/rails log:clear tmp:clear
echo

echo "✓ Setup complete!"
echo ""
echo "  Run 'bin/dev' to start the development server."
echo ""
