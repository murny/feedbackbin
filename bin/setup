#!/usr/bin/env bash
set -eo pipefail

app_root="$(
  cd "$(dirname "$0")/.."
  pwd
)"
export PATH="$app_root/bin:$PATH"

# Install gum if needed
if ! command -v gum &>/dev/null; then
  echo
  echo "▸ Installing gum"
  if command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm gum
  elif command -v brew &>/dev/null; then
    brew install gum
  else
    echo "Please install gum: https://github.com/charmbracelet/gum"
    exit 1
  fi
  echo
fi

# Install mise if needed
if ! command -v mise &>/dev/null; then
  echo
  echo "▸ Installing mise"
  if command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm mise
  elif command -v brew &>/dev/null; then
    brew install mise
  else
    echo "Please install mise: https://mise.jdx.dev/installing-mise.html#installation-methods"
    exit 1
  fi
  echo
fi

# Install gh if needed
if ! command -v gh &>/dev/null; then
  echo
  echo "▸ Installing GitHub CLI"
  if command -v pacman &>/dev/null; then
    sudo pacman -S --noconfirm github-cli
  elif command -v brew &>/dev/null; then
    brew install gh
  else
    echo "Please install GitHub CLI: https://github.com/cli/cli#installation"
    exit 1
  fi
  echo
fi

step() {
  local step_name="$1"
  shift

  gum style --foreground 135 --bold "▸ $step_name"
  gum style --foreground 240 "$*"

  "$@"

  local exit_code=$?
  echo
  return $exit_code
}

needs_seeding() {
  if [ -n "$CI" ]; then
    return 1
  fi

  has_data=$(bin/rails runner "pp Account.any?" 2>/dev/null)
  if [ "$has_data" = "true" ]; then
    return 1
  else
    return 0
  fi
}

echo
gum style --foreground 153 "______            _ _                _   ______ _       "
gum style --foreground 153 "|  ___|          | | |              | |  | ___ (_)      "
gum style --foreground 153 "| |_ ___  ___  __| | |__   __ _  ___| | _| |_/ /_ _ __  "
gum style --foreground 153 "|  _/ _ \\/ _ \\/ _\` | '_ \\ / _\` |/ __| |/ / ___ \\ | '_ \\ "
gum style --foreground 153 "| ||  __/  __/ (_| | |_) | (_| | (__|   <| |_/ / | | | |"
gum style --foreground 153 "\\_| \\___|\\___|\\__,_|_.__/ \\__,_|\\___|_|\\_\\____/|_|_| |_|"
echo

step "Installing Ruby" mise install --yes
eval "$(mise hook-env -s bash)"

if which pacman >/dev/null 2>&1; then
  packages=(imagemagick openslide libvips gitleaks)
  if ! pacman -Q "${packages[@]}" >/dev/null 2>&1; then
    step "Installing packages" sudo pacman -S --noconfirm --needed "${packages[@]}"
  fi
elif which brew >/dev/null 2>&1; then
  packages=(imagemagick openslide vips gitleaks)
  missing_packages=()
  for pkg in "${packages[@]}"; do
    if ! brew list "$pkg" &>/dev/null; then
      missing_packages+=("$pkg")
    fi
  done
  if [ ${#missing_packages[@]} -gt 0 ]; then
    step "Installing packages" brew install "${missing_packages[@]}"
  fi
fi

bundle config set --local auto_install true
step "Installing RubyGems" bundle install

if [[ "$*" == *--clean* ]]; then
  step "Cleaning storage" find ./storage/db ./storage/files -mindepth 1 -not -name '.keep' -delete
fi

if [[ "$*" == *--reset* ]]; then
  step "Resetting database" bin/rails db:reset
else
  step "Preparing database" bin/rails db:prepare

  if needs_seeding; then
    step "Seeding database" bin/rails db:seed
  fi
fi

step "Cleaning up logs and temp files" bin/rails log:clear tmp:clear

gum style --foreground 46 "✓ Setup complete (${SECONDS} sec)"
echo
gum style --foreground 240 --bold "Run 'bin/dev' to start the development server."

