#!/usr/bin/env bash
set -eo pipefail

app_root="$(
  cd "$(dirname "$0")/.."
  pwd
)"
export PATH="$app_root/bin:$PATH"
cd "$app_root"

install_packages() {
  local packages=("$@")
  local missing=()

  if command -v brew &>/dev/null; then
    for pkg in "${packages[@]}"; do
      if ! brew list "$pkg" &>/dev/null; then
        missing+=("$pkg")
      fi
    done
    if [ ${#missing[@]} -gt 0 ]; then
      echo "▸ Installing packages: ${missing[*]}"
      brew install "${missing[@]}"
      echo
    fi
  elif command -v pacman &>/dev/null; then
    for pkg in "${packages[@]}"; do
      if ! pacman -Q "$pkg" &>/dev/null; then
        missing+=("$pkg")
      fi
    done
    if [ ${#missing[@]} -gt 0 ]; then
      echo "▸ Installing packages: ${missing[*]}"
      sudo pacman -S --noconfirm --needed "${missing[@]}"
      echo
    fi
  elif command -v apt-get &>/dev/null; then
    for pkg in "${packages[@]}"; do
      if ! dpkg -s "$pkg" >/dev/null 2>&1; then
        missing+=("$pkg")
      fi
    done
    if [ ${#missing[@]} -gt 0 ]; then
      echo "▸ Installing packages: ${missing[*]}"
      sudo apt-get update
      sudo apt-get install -y "${missing[@]}"
      echo
    fi
  fi
}

step() {
  local step_name="$1"
  shift

  gum style --foreground 135 --bold "▸ $step_name"
  gum style --foreground 240 "$*"

  "$@"

  local exit_code=$?
  echo
  return $exit_code
}

ensure_command() {
  local cmd="$1"
  local label="$2"
  local install_url="$3"
  local brew_pkg="$4"
  local pacman_pkg="$5"
  local apt_pkg="$6"
  local required="${7:-true}"

  if command -v "$cmd" &>/dev/null; then
    return 0
  fi

  echo
  echo "▸ Installing $label"
  if command -v brew &>/dev/null && [ -n "$brew_pkg" ]; then
    install_packages "$brew_pkg"
  elif command -v pacman &>/dev/null && [ -n "$pacman_pkg" ]; then
    install_packages "$pacman_pkg"
  elif command -v apt-get &>/dev/null && [ -n "$apt_pkg" ]; then
    install_packages "$apt_pkg"
  else
    echo "Please install $label: $install_url"
    if [ "$required" = "true" ]; then
      exit 1
    fi
    echo
    return 0
  fi

  if ! command -v "$cmd" &>/dev/null; then
    echo "Please install $label: $install_url"
    if [ "$required" = "true" ]; then
      exit 1
    fi
  fi

  echo
}

needs_seeding() {
  if [ -n "$CI" ]; then
    return 1
  fi

  has_data=$(bin/rails runner "print Account.any?" 2>/dev/null || echo "false")
  [ "$has_data" != "true" ]
}

ensure_command "gum" "gum" "https://github.com/charmbracelet/gum" "gum" "gum" "" "true"
ensure_command "mise" "mise" "https://mise.jdx.dev/installing-mise.html#installation-methods" "mise" "mise" "" "true"
ensure_command "gh" "GitHub CLI" "https://github.com/cli/cli#installation" "gh" "github-cli" "gh" "true"

echo
gum style --foreground 153 "______            _ _                _   ______ _       "
gum style --foreground 153 "|  ___|          | | |              | |  | ___ (_)      "
gum style --foreground 111 --bold "| |_ ___  ___  __| | |__   __ _  ___| | _| |_/ /_ _ __  "
gum style --foreground 111 --bold "|  _/ _ \\/ _ \\/ _\` | '_ \\ / _\` |/ __| |/ / ___ \\ | '_ \\ "
gum style --foreground 153 "| ||  __/  __/ (_| | |_) | (_| | (__|   <| |_/ / | | | |"
gum style --foreground 153 "\\_| \\___|\\___|\\__,_|_.__/ \\__,_|\\___|_|\\_\\____/|_|_| |_|"
echo

step "Installing Ruby" mise install --yes
eval "$(mise hook-env -s bash)"

if command -v brew &>/dev/null; then
  system_packages=(imagemagick openslide vips gitleaks)
  install_packages "${system_packages[@]}"
elif command -v pacman &>/dev/null; then
  system_packages=(imagemagick openslide libvips gitleaks)
  install_packages "${system_packages[@]}"
elif command -v apt-get &>/dev/null; then
  system_packages=(imagemagick libopenslide-dev libvips-dev)
  install_packages "${system_packages[@]}"
  if ! command -v gitleaks &>/dev/null; then
    echo "▸ gitleaks not found (used for secret scanning)"
    echo "  Install manually: https://github.com/gitleaks/gitleaks#installing"
    echo
  fi
else
  if ! command -v vips &>/dev/null; then
    echo "Please install libvips manually: https://www.libvips.org/install.html"
    exit 1
  fi
  if ! command -v magick &>/dev/null && ! command -v convert &>/dev/null; then
    echo "Please install ImageMagick manually: https://imagemagick.org/script/download.php"
    exit 1
  fi
  if ! command -v openslide-show-properties &>/dev/null; then
    echo "Please install OpenSlide manually: https://openslide.org/download/"
    exit 1
  fi
  if ! command -v gitleaks &>/dev/null; then
    echo "▸ gitleaks not found (used for secret scanning)"
    echo "  Please install gitleaks manually: https://github.com/gitleaks/gitleaks#installing"
    echo
  fi
fi

bundle config set --local auto_install true
step "Installing Ruby dependencies" bundle check || bundle install

if [[ "$*" == *--reset* ]]; then
  step "Resetting database" bin/rails db:reset
else
  step "Preparing database" bin/rails db:prepare

  if needs_seeding; then
    step "Seeding database" bin/rails db:seed
  fi
fi

step "Cleaning up logs and temp files" bin/rails log:clear tmp:clear

gum style --foreground 46 "✓ Setup complete (${SECONDS} sec)"
echo
gum style --foreground 240 "Run 'bin/dev' to start the development server."
echo
