/* ==========================================================================
   Select Components

   Native <select> and custom JS-powered select (with popover + combobox).

   Usage:
     <select><option>...</option></select>

   Custom select:
     <div class="select">
       <button>Trigger</button>
       <div data-popover>
         <div role="option">Option 1</div>
       </div>
     </div>
   ========================================================================== */

@layer components {
  /* Native Select
  /* ------------------------------------------------------------------------ */

  select,
  select.select {
    /* Component API */
    --select-height: 2.25rem;
    --select-padding-inline-start: 0.75rem;
    --select-padding-inline-end: 2.25rem;
    --select-radius: var(--radius-md);
    --select-border-color: var(--color-input);

    /* Structure */
    appearance: none;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
    block-size: var(--select-height);
    inline-size: fit-content;
    padding-inline-start: var(--select-padding-inline-start);
    padding-inline-end: var(--select-padding-inline-end);
    padding-block: 0.5rem;

    /* Appearance */
    background-color: transparent;
    background-image: var(--chevron-down-icon-50);
    background-repeat: no-repeat;
    background-position: center right 0.75rem;
    background-size: 1rem;
    border: 1px solid var(--select-border-color);
    border-radius: var(--select-radius);
    box-shadow: var(--shadow-xs);

    /* Typography */
    font-size: var(--text-sm);
    white-space: nowrap;

    /* Behavior */
    outline: none;
    transition: color var(--duration-fast) var(--ease-out),
                box-shadow var(--duration-fast) var(--ease-out),
                border-color var(--duration-fast) var(--ease-out);

    option,
    optgroup {
      background-color: var(--color-popover);
      color: var(--color-popover-foreground);
    }

    &:focus-visible {
      border-color: var(--color-ring);
      box-shadow: 0 0 0 2px oklch(from var(--color-ring) l c h / 40%);
    }

    &:user-invalid,
    &[aria-invalid="true"] {
      border-color: var(--color-destructive);
      box-shadow: 0 0 0 2px oklch(from var(--color-destructive) l c h / 20%);
    }

    &:disabled {
      pointer-events: none;
      cursor: not-allowed;
      opacity: 0.5;
    }

    html[data-theme="dark"] & {
      background-color: oklch(from var(--color-input) l c h / 30%);

      &:hover {
        background-color: oklch(from var(--color-input) l c h / 50%);
      }
    }

    @media (prefers-color-scheme: dark) {
      html:not([data-theme]) & {
        background-color: oklch(from var(--color-input) l c h / 30%);

        &:hover {
          background-color: oklch(from var(--color-input) l c h / 50%);
        }
      }
    }
  }

  /* Custom Select (JS-powered)
  /* ------------------------------------------------------------------------ */

  *:not(select).select {
    position: relative;
    display: inline-flex;

    [data-popover] {
      padding: 0.25rem;

      [role='option'] {
        position: relative;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        inline-size: 100%;
        padding-inline-start: 0.5rem;
        padding-inline-end: 1.875rem;
        padding-block: 0.375rem;
        border-radius: var(--radius-sm);
        font-size: var(--text-sm);
        cursor: default;
        user-select: none;
        outline: none;
        overflow: hidden;
        text-overflow: ellipsis;

        &[aria-hidden="true"] {
          display: none;
        }

        &[aria-disabled="true"],
        &:disabled {
          opacity: 0.5;
          pointer-events: none;
        }

        svg {
          inline-size: 1rem;
          block-size: 1rem;
          flex-shrink: 0;
          color: var(--color-muted-foreground);
        }

        &[aria-selected='true'] {
          background-image: var(--check-icon);
          background-repeat: no-repeat;
          background-position: center right 0.5rem;
          background-size: 0.875rem;
        }

        &.active,
        &:focus-visible {
          background-color: var(--color-accent);
          color: var(--color-accent-foreground);
        }
      }

      [role='listbox'] [role='heading'] {
        display: flex;
        padding-inline: 0.5rem;
        padding-block: 0.375rem;
        font-size: var(--text-xs);
        color: var(--color-muted-foreground);
      }

      [role='listbox'] [role='group']:not(:has([role='option']:not([aria-hidden='true']))) {
        display: none;
      }

      [role='separator'] {
        margin-inline: -0.25rem;
        margin-block: 0.25rem;
        border-color: var(--color-border);
      }

      > header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        block-size: 2.25rem;
        padding-inline: 0.75rem;
        margin-inline: -0.25rem;
        margin-block-start: -0.25rem;
        margin-block-end: 0.25rem;
        border-block-end: 1px solid var(--color-border);

        svg {
          inline-size: 1rem;
          block-size: 1rem;
          flex-shrink: 0;
          opacity: 0.5;
        }

        input[role='combobox'] {
          flex: 1;
          inline-size: 100%;
          min-inline-size: 0;
          block-size: 2.5rem;
          padding-block: 0.75rem;
          background-color: transparent;
          border: none;
          font-size: var(--text-sm);
          outline: none;

          &::placeholder {
            color: var(--color-muted-foreground);
          }

          &:disabled {
            cursor: not-allowed;
            opacity: 0.5;
          }
        }
      }

      [role='listbox']:not(:has([data-value]:not([aria-hidden='true'])))::before {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1.5rem;
        font-size: var(--text-sm);
        overflow: hidden;
        text-overflow: ellipsis;
      }

      [role='listbox'][data-empty]:not(:has([data-value]:not([aria-hidden='true'])))::before {
        content: attr(data-empty);
      }

      [role='listbox']:not([data-empty]):not(:has([data-value]:not([aria-hidden='true'])))::before {
        content: 'No results found';
      }
    }

    &:not([data-select-initialized]) [data-popover] [role='option'] {
      &:hover {
        background-color: var(--color-accent);
        color: var(--color-accent-foreground);
      }
    }
  }
}
