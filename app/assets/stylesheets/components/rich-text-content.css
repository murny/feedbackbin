/* ==========================================================================
   Rich Text Content Component

   Usage:
     <div class="rich-text-content">
       <p>User-generated content from ActionText/Trix</p>
     </div>

   Provides typography and layout for user-generated content including
   headings, lists, blockquotes, code blocks, tables, and attachments.
   ========================================================================== */

@layer components {
  /* Rich Text Content Container
  /* ------------------------------------------------------------------------ */

  :where(.rich-text-content) {
    /* Component API */
    --rich-text-block-margin: 0.5lh;

    /* Headings */
    h1, h2, h3, h4, h5, h6 {
      display: block;
      font-weight: 800;
      letter-spacing: -0.02ch;
      line-height: 1.1;
      margin-block: 0 var(--rich-text-block-margin);
      overflow-wrap: break-word;
      text-wrap: balance;
    }

    h1 { font-size: 2em; }
    h2 { font-size: 1.5em; }
    h3 { font-size: 1.17em; }
    h4 { font-size: 1em; }
    h5 { font-size: 0.83em; }
    h6 { font-size: 0.67em; }

    /* Block elements */
    p, ul, ol, dl, blockquote, figure, .attachment {
      margin-block: 0 var(--rich-text-block-margin);

      &:not(lexxy-editor &) {
        overflow-wrap: break-word;
        text-wrap: pretty;
      }
    }

    /* Consecutive paragraphs collapse margin */
    p:has(+ p) {
      margin: 0;
    }

    /* Lists */
    ol, ul {
      padding-inline-start: 3ch;
    }

    ol {
      list-style: decimal;
    }

    ul {
      list-style: disc;
    }

    /* Nested lists */
    li:has(li) {
      list-style: none;

      ol, ul {
        margin: 0;
        padding-inline-start: 2ch;
      }
    }

    /* Text formatting */
    b, strong, .lexxy-content__bold {
      font-weight: 700;
    }

    i, em, .lexxy-content__italic {
      font-style: italic;
    }

    s, .lexxy-content__strikethrough {
      text-decoration: line-through;
    }

    mark, .lexxy-content__highlight {
      background-color: transparent;
      color: inherit;
    }

    p, blockquote {
      letter-spacing: -0.005ch;
    }

    /* Empty paragraphs */
    p:empty {
      display: none;
    }

    /* Blockquotes */
    blockquote {
      border-inline-start: 0.25em solid var(--color-border);
      font-style: italic;
      margin: var(--rich-text-block-margin) 0;
      padding-inline-start: 2ch;
    }

    /* Media */
    img, video, embed, object {
      inline-size: auto;
      margin-inline: auto;
      max-block-size: 32rem;
      object-fit: contain;
    }

    /* Links containing media */
    a:has(img),
    a:has(video) {
      inline-size: fit-content;
      margin-inline: auto;
    }

    /* Horizontal rule */
    hr {
      color: currentColor;
      block-size: 0;
      border: none;
      border-block-end: 2px solid currentColor;
      inline-size: 20%;
      margin: calc(var(--rich-text-block-margin) * 2) 0;
    }

    .horizontal-divider {
      margin: var(--rich-text-block-margin) 0;
      padding-block: var(--rich-text-block-margin);
    }

    /* Code blocks */
    code, pre {
      background-color: var(--color-muted);
      border: 1px solid var(--color-border);
      border-radius: 0.3em;
      color: var(--color-foreground);
      font-family: ui-monospace, monospace;
      font-size: 0.85em;
      font-weight: 500;
      margin-block: var(--rich-text-block-margin);
      padding: 0.1em 0.3em;

      &:is(pre),
      &[data-language] {
        border-radius: 0.5em;
        display: block;
        overflow-x: auto;
        padding: 0.5lh 2ch;
        tab-size: 2;
        text-wrap: nowrap;
        white-space: pre;
        word-break: break-word;

        /* Keywords and attributes */
        .code-token__attr,
        .token.atrule,
        .token.attr,
        .token.keyword {
          color: var(--color-code-token-attr, #7c3aed);
        }

        /* Constants, booleans, numbers, properties, tags */
        .code-token__property,
        .token.boolean,
        .token.constant,
        .token.deleted,
        .token.number,
        .token.property,
        .token.symbol,
        .token.tag {
          color: var(--color-code-token-property, #dc2626);
        }

        /* Strings, selectors, and built-in constructs */
        .code-token__selector,
        .token.builtin,
        .token.char,
        .token.inserted,
        .token.selector,
        .token.string {
          color: var(--color-code-token-selector, #16a34a);
        }

        /* Comments and meta information */
        .code-token__comment,
        .token.cdata,
        .token.comment,
        .token.doctype,
        .token.prolog {
          color: var(--color-code-token-comment, #6b7280);
          font-style: italic;
        }

        /* Operators and symbolic entities */
        .code-token__operator,
        .token.entity,
        .token.operator,
        .token.url {
          color: var(--color-code-token-operator, #0891b2);
        }

        /* Functions and class names */
        .code-token__function,
        .token.class,
        .token.class-name,
        .token.function {
          color: var(--color-code-token-function, #2563eb);
        }

        /* Variables, regex, namespaces, important */
        .code-token__variable,
        .token.important,
        .token.namespace,
        .token.regex,
        .token.variable {
          color: var(--color-code-token-variable, #ea580c);
        }

        /* Punctuation */
        .code-token__punctuation,
        .token.punctuation {
          color: var(--color-code-token-punctuation, #475569);
        }
      }
    }

    /* Tables */
    .lexxy-content__table-wrapper {
      margin: 0;
      margin-block: 1ch;
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      border-spacing: 0;
      inline-size: calc(100% - 0.5ch);
      margin: 0.25ch;

      th,
      td {
        border: 1px solid var(--color-border);
        padding: 0.5ch 1ch;
        text-align: start;
        word-break: normal;

        *:last-child {
          margin-block-end: 0;
        }

        *:not(pre, code) {
          word-break: normal;
        }
      }

      th,
      .lexxy-content__table-cell--header {
        background: var(--color-accent);
      }

      td {
        background: var(--color-card);
      }
    }
  }

  /* Attachments
  /* ------------------------------------------------------------------------ */

  .attachment {
    block-size: auto;
    display: block;
    inline-size: fit-content;
    position: relative;
    max-inline-size: 100%;

    progress {
      inline-size: 100%;
      margin: auto;
    }
  }

  .attachment__caption {
    color: var(--color-muted-foreground);
    font-size: 0.875rem;

    textarea {
      --input-border-radius: 0.3em;
      --input-border-size: 0;
      --input-padding: 0;

      background-color: transparent;
      border: none;
      color: inherit;
      inline-size: 100%;
      max-inline-size: 100%;
      resize: none;
      text-align: center;

      &:focus {
        outline: none;
      }

      @supports (field-sizing: content) {
        field-sizing: content;
        inline-size: auto;
        min-inline-size: 20ch;
      }
    }
  }

  .attachment__icon {
    aspect-ratio: 4/5;
    background-color: color-mix(in oklch, var(--color-muted-foreground) 10%, transparent);
    block-size: 2.5lh;
    border: 2px solid var(--color-muted-foreground);
    border-block-start-width: 1ch;
    border-radius: 0.5ch;
    box-sizing: border-box;
    color: var(--color-muted-foreground);
    display: grid;
    font-size: 0.875rem;
    font-weight: bold;
    inline-size: auto;
    padding-inline: 0.5ch;
    place-content: center;
    text-transform: uppercase;
    white-space: nowrap;
  }

  /* Attachment with preview (images/videos) */
  .attachment--preview {
    margin-inline: auto;
    text-align: center;

    img, video {
      block-size: auto;
      display: block;
      margin-inline: auto;
      max-inline-size: 100%;
      user-select: none;
    }

    > a {
      display: block;
    }

    .attachment__caption {
      column-gap: 0.5ch;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-block-start: 0.5ch;
    }
  }

  /* File attachment */
  .attachment--file {
    --attachment-icon-color: var(--color-muted-foreground);

    align-items: center;
    display: flex;
    flex-wrap: wrap;
    gap: 1ch;
    inline-size: 100%;
    margin-inline: 0;

    .attachment__caption {
      display: grid;
      flex: 1;
      text-align: start;
    }

    .attachment__name {
      color: var(--color-foreground);
      font-weight: bold;
    }

    &:has(video) {
      .attachment__caption {
        flex: none;
        inline-size: 100%;
      }
    }
  }

  /* File type colors */
  .attachment--psd,
  .attachment--key,
  .attachment--sketch,
  .attachment--ai,
  .attachment--eps,
  .attachment--indd,
  .attachment--svg,
  .attachment--ppt,
  .attachment--pptx {
    --attachment-icon-color: oklch(0.6 0.2 25);
  }

  .attachment--css,
  .attachment--crash,
  .attachment--php,
  .attachment--json,
  .attachment--htm,
  .attachment--html,
  .attachment--rb,
  .attachment--erb,
  .attachment--ts,
  .attachment--js {
    --attachment-icon-color: oklch(0.6 0.2 290);
  }

  .attachment--txt,
  .attachment--pages,
  .attachment--rtf,
  .attachment--md,
  .attachment--doc,
  .attachment--docx {
    --attachment-icon-color: oklch(0.6 0.2 240);
  }

  .attachment--csv,
  .attachment--numbers,
  .attachment--xls,
  .attachment--xlsx {
    --attachment-icon-color: oklch(0.6 0.2 145);
  }

  .attachment__link {
    color: var(--color-primary);
    text-decoration: underline;
  }

  /* Custom ActionText attachments (mentions, etc.) */
  action-text-attachment[content-type^='application/vnd.actiontext'] {
    --attachment-bg-color: transparent;
    --attachment-image-size: 1em;
    --attachment-text-color: currentColor;

    align-items: center;
    background: var(--attachment-bg-color);
    border-radius: 99rem;
    box-shadow:
      -0.25ch 0 0 var(--attachment-bg-color),
       0.5ch 0 0 var(--attachment-bg-color);
    color: var(--attachment-text-color);
    display: inline-flex;
    gap: 0.25ch;
    margin: 0;
    padding: 0;
    position: relative;
    vertical-align: bottom;
    white-space: normal;

    lexxy-editor & {
      cursor: pointer;
    }

    img {
      block-size: var(--attachment-image-size);
      border-radius: 50%;
      inline-size: var(--attachment-image-size);
    }

    &.node--selected {
      --attachment-bg-color: var(--color-primary);
      --attachment-text-color: var(--color-primary-foreground);
    }
  }

  action-text-attachment[content-type^='application/vnd.actiontext.mention'] {
    img {
      object-fit: cover;
    }
  }

  [data-lexical-cursor] {
    animation: blink 1s step-end infinite;
    block-size: 1lh;
    border-inline-start: 1px solid currentColor;
    line-height: inherit;
    margin-block: 1em;
  }

  /* Prose â€” rich text content styling for user-generated content
  /* ------------------------------------------------------------------------ */

  .prose {
    font-size: var(--text-normal);
    line-height: 1.75;
    color: var(--color-ink);
  }
  .prose :where(p):not(:where([class~="not-prose"] *)) { margin-block: 1.25em; }
  .prose :where(h2):not(:where([class~="not-prose"] *)) { font-size: 1.5em; font-weight: bold; margin-block-start: 2em; margin-block-end: 1em; }
  .prose :where(h3):not(:where([class~="not-prose"] *)) { font-size: 1.25em; font-weight: 600; margin-block-start: 1.6em; margin-block-end: 0.6em; }
  .prose :where(ul):not(:where([class~="not-prose"] *)) { list-style-type: disc; padding-inline-start: 1.625em; margin-block: 1.25em; }
  .prose :where(ol):not(:where([class~="not-prose"] *)) { list-style-type: decimal; padding-inline-start: 1.625em; margin-block: 1.25em; }
  .prose :where(li):not(:where([class~="not-prose"] *)) { margin-block: 0.5em; }
  .prose :where(blockquote):not(:where([class~="not-prose"] *)) { border-inline-start: 3px solid var(--color-border); padding-inline-start: 1em; font-style: italic; margin-block: 1.6em; }
  .prose :where(a):not(:where([class~="not-prose"] *)) { color: var(--color-link); text-decoration: underline; }
  .prose :where(img):not(:where([class~="not-prose"] *)) { margin-block: 2em; border-radius: var(--radius-md); }
}
