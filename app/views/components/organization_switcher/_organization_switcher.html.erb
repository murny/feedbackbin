<%# locals: (current_organization:, organizations:, classes: "") %>

<div class="relative inline-block <%= classes %>" data-controller="dropdown">
  <button type="button"
          class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-10 px-4 py-2 w-[280px]"
          id="organization-switcher-button"
          aria-expanded="false"
          aria-haspopup="true"
          data-action="click->dropdown#toggle click@window->dropdown#hide">
    <div class="flex items-center gap-3 min-w-0 flex-1">
      <% if current_organization&.logo&.attached? %>
        <%= image_tag current_organization.logo, class: "h-5 w-5 rounded-sm flex-shrink-0", alt: "" %>
      <% else %>
        <div class="h-5 w-5 rounded-sm bg-muted flex-shrink-0 flex items-center justify-center">
          <span class="text-xs font-medium text-muted-foreground">
            <%= current_organization.name.first.upcase %>
          </span>
        </div>
      <% end %>
      <span class="truncate text-sm font-medium">
        <%= current_organization.name %>
      </span>
    </div>
    <svg class="h-4 w-4 text-muted-foreground opacity-50" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
    </svg>
  </button>

  <div class="hidden absolute left-0 z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md w-[280px]"
       role="menu"
       aria-orientation="vertical"
       aria-labelledby="organization-switcher-button"
       tabindex="-1"
       data-dropdown-target="menu"
       data-dropdown-toggle-class="hidden"
       data-dropdown-open-value="false"
       data-transition-enter="transition ease-out duration-200"
       data-transition-enter-from="opacity-0 scale-95"
       data-transition-enter-to="opacity-100 scale-100"
       data-transition-leave="transition ease-in duration-75"
       data-transition-leave-from="opacity-100 scale-100"
       data-transition-leave-to="opacity-0 scale-95">

    <% if organizations.any? %>
      <div class="px-2 py-1.5">
        <div class="px-2 py-1.5 text-xs font-semibold text-muted-foreground">
          <%= t(".switch_organization") %>
        </div>
        <% organizations.each do |organization| %>
          <% if organization.id == current_organization&.id %>
            <div class="relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none bg-accent text-accent-foreground gap-2" role="none">
              <% if organization.logo&.attached? %>
                <%= image_tag organization.logo, class: "h-4 w-4 rounded-sm flex-shrink-0", alt: "" %>
              <% else %>
                <div class="h-4 w-4 rounded-sm bg-muted flex items-center justify-center flex-shrink-0">
                  <span class="text-xs font-medium text-muted-foreground">
                    <%= organization.name.first.upcase %>
                  </span>
                </div>
              <% end %>
              <span class="truncate text-sm font-medium">
                <%= organization.name %>
              </span>
              <svg class="ml-auto h-4 w-4 flex-shrink-0" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
              </svg>
            </div>
          <% else %>
            <%= button_to organization_switch_path(organization),
                  method: :post,
                  params: { return_to: request.fullpath },
                  class: "relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground gap-2",
                  role: "menuitem",
                  tabindex: "-1" do %>
              <% if organization.logo&.attached? %>
                <%= image_tag organization.logo, class: "h-4 w-4 rounded-sm flex-shrink-0", alt: "" %>
              <% else %>
                <div class="h-4 w-4 rounded-sm bg-muted flex items-center justify-center flex-shrink-0">
                  <span class="text-xs font-medium text-muted-foreground">
                    <%= organization.name.first.upcase %>
                  </span>
                </div>
              <% end %>
              <span class="truncate text-sm font-medium">
                <%= organization.name %>
              </span>
            <% end %>
          <% end %>
        <% end %>
      </div>
      <div class="border-t border-border"></div>
    <% end %>

    <div class="px-2 py-1.5">
      <%= link_to new_organization_path,
            class: "relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
            role: "menuitem",
            tabindex: "-1" do %>
        <svg class="mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5Z" />
        </svg>
        <%= t(".create_organization") %>
      <% end %>

      <% if current_organization %>
        <%= link_to organizations_path,
              class: "relative flex w-full cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground",
              role: "menuitem",
              tabindex: "-1" do %>
          <svg class="mr-2 h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M4.25 2A2.25 2.25 0 002 4.25v2.5A2.25 2.25 0 004.25 9h2.5A2.25 2.25 0 009 6.75v-2.5A2.25 2.25 0 006.75 2h-2.5zm0 9A2.25 2.25 0 002 13.25v2.5A2.25 2.25 0 004.25 18h2.5A2.25 2.25 0 009 15.75v-2.5A2.25 2.25 0 006.75 11h-2.5zm9-9A2.25 2.25 0 0011 4.25v2.5A2.25 2.25 0 0013.25 9h2.5A2.25 2.25 0 0018 6.75v-2.5A2.25 2.25 0 0015.75 2h-2.5zm0 9A2.25 2.25 0 0011 13.25v2.5A2.25 2.25 0 0013.25 18h2.5A2.25 2.25 0 0018 15.75v-2.5A2.25 2.25 0 0015.75 11h-2.5z" clip-rule="evenodd" />
          </svg>
          <%= t(".manage_organizations") %>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
