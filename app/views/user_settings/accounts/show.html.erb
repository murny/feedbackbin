<% content_for(:title) { t("user_settings.page_titles.account") } %>

<div class="container">
  <%= render partial: "user_settings/header" %>

  <div class="flex flex-column" style="margin-block-start: var(--space-8); gap: var(--space-6);">
        <div class="card" style="padding: var(--space-6);">
          <div class="flex flex-column" style="gap: var(--space-6);">
            <div>
              <h2 class="txt-large font-weight-medium"><%= t(".email_address") %></h2>
              <p class="txt-small txt-subtle"><%= t(".email_address_hint") %></p>
            </div>

            <%= form_with(model: @identity, scope: :identity,
                  url: user_settings_email_path,
                  method: :patch,
                  data: { controller: "form", action: "keydown.enter->form#submit:prevent" }) do |form| %>
              <div class="grid" style="gap: var(--space-4);">
                <div class="grid" style="gap: var(--space-2);">
                  <%= form.label :email_address, class: "txt-small font-weight-medium" %>
                  <%= form.email_field :email_address, required: true, autocomplete: "email", placeholder: t(".email_address_placeholder"), class: "full-width" %>
                  <div class="flex align-center justify-space-between">
                    <p class="txt-x-small txt-subtle"><%= t(".email_address_hint") %></p>
                    <% if @user.identity.email_verified_at.present? %>
                      <div class="flex align-center" style="gap: var(--space-1); color: var(--color-positive);">
                        <%= lucide_icon "circle-check", style: "inline-size: 1rem; block-size: 1rem;" %>
                        <span class="txt-x-small font-weight-medium"><%= t(".verified") %></span>
                      </div>
                    <% else %>
                      <div class="flex align-center" style="gap: var(--space-1); color: var(--color-marker);">
                        <%= lucide_icon "circle-alert", style: "inline-size: 1rem; block-size: 1rem;" %>
                        <span class="txt-x-small font-weight-medium"><%= t(".unverified") %></span>
                      </div>
                    <% end %>
                  </div>
                </div>

                <% if @identity.has_password? %>
                  <div class="grid" style="gap: var(--space-2);">
                    <%= form.label :password_challenge, t(".current_password"), class: "txt-small font-weight-medium" %>
                    <%= form.password_field :password_challenge, autocomplete: "current-password", required: true, class: "full-width" %>
                  </div>
                <% end %>
              </div>

              <div class="flex justify-end" style="gap: var(--space-3); padding-block-start: var(--space-6);">
                <%= form.submit t(".update_email_address"), class: "btn" %>
              </div>
            <% end %>
          </div>
        </div>

        <% unless @user.identity.email_verified_at.present? %>
          <div class="card border txt-alert" style="padding: var(--space-6); border-color: var(--color-marker); background-color: oklch(from var(--color-marker) l c h / 10%);">
            <div class="flex">
              <div class="flex-item-no-shrink">
                <%= lucide_icon "triangle-alert", style: "inline-size: 1.25rem; block-size: 1.25rem;" %>
              </div>
              <div style="margin-inline-start: var(--space-3);">
                <h3 class="txt-small font-weight-medium">
                  <%= t(".email_not_verified") %>
                </h3>
                <div class="txt-small" style="margin-block-start: var(--space-2);">
                  <p><%= t(".email_verification_description") %></p>
                </div>
                <div style="margin-block-start: var(--space-4);">
                  <%= button_to t(".resend_verification_email"), users_email_verification_path,
                        method: :post,
                        class: "btn btn--sm" %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <div class="card" style="padding: var(--space-6);">
          <div class="flex flex-column" style="gap: var(--space-6);">
            <div>
              <h2 class="txt-large font-weight-medium"><%= t(".connected_accounts") %></h2>
              <p class="txt-small txt-subtle"><%= t(".connected_accounts_description") %></p>
            </div>

            <div class="grid" style="gap: var(--space-3);">
              <% omniauth_providers = [ "google", "facebook" ] %>
              <% omniauth_providers << "developer" unless Rails.env.production? %>
              <% omniauth_providers.each do |provider| %>
                <div class="flex align-center justify-space-between pad border border-radius">
                  <div class="flex align-center" style="gap: var(--space-3);">
                    <%= inline_svg_tag "icons/brand/#{provider}.svg", style: "inline-size: 1.25rem; block-size: 1.25rem;" %>
                    <div>
                      <span class="txt-small font-weight-medium"><%= OmniAuth::Utils.camelize(provider) %></span>
                      <% if (connected_account = @identity_connected_accounts.find_by(provider_name: provider)) %>
                        <p class="txt-x-small txt-subtle"><%= t(".connected_account_label") %></p>
                      <% else %>
                        <p class="txt-x-small txt-subtle"><%= t(".not_connected") %></p>
                      <% end %>
                    </div>
                  </div>
                  <div class="flex-item-no-shrink">
                    <% if (connected_account = @identity_connected_accounts.find_by(provider_name: provider)) %>
                      <%= button_to t(".disconnect"), user_settings_connected_account_path(connected_account),
                            method: :delete,
                            class: "btn btn--destructive btn--sm",
                            form: { data: { turbo_confirm: t(".disconnect_confirm") } } %>
                    <% else %>
                      <%= button_to t(".connect"), "/auth/#{provider}",
                            method: :post,
                            data: { turbo: false, disable_with: t(".redirecting") },
                            class: "btn btn--sm" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          </div>
        </div>

        <div class="card border txt-negative" style="padding: var(--space-6); border-color: var(--color-negative); background-color: oklch(from var(--color-negative) l c h / 10%);">
          <div class="flex flex-column" style="gap: var(--space-4);">
            <div>
              <h2 class="txt-large font-weight-medium"><%= t(".delete_account") %></h2>
              <p class="txt-small"><%= t(".delete_account_description") %></p>
            </div>

            <div style="padding-block-start: var(--space-4);">
              <%= button_to user_path(@user), method: :delete, data: { turbo_confirm: t(".delete_account_confirm") }, class: "btn btn--destructive" do %>
                <%= t(".delete_my_account") %>
              <% end %>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>
