<%# locals: (comment:) %>

<%= turbo_frame_tag dom_id(comment) do %>
  <div id="<%= dom_id(comment) %>" class="py-6 scroll-mt-4">
    <% if comment.creator.system? %>
      <%# System comment - simplified styling for audit trail %>
      <div class="p-3 text-sm bg-muted/30 border border-muted rounded-lg">
        <div class="flex items-center gap-2">
          <%= lucide_icon("info", class: "w-4 h-4 text-muted-foreground") %>
          <div class="flex-1">
            <p class="text-muted-foreground">
              <%= sanitize(comment.body, tags: %w[strong]) %>
            </p>
          </div>
          <%= local_datetime_tag comment.created_at, style: :datetime, class: "text-xs text-muted-foreground" %>
        </div>
      </div>
    <% else %>
      <%# Regular user comment %>
      <div class="p-4 lg:p-6 text-base bg-card border border-border rounded-lg">
        <div class="flex">
          <div class="mr-4">
            <%= render partial: "votes/vote_button", locals: { voteable: comment } %>
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-center mb-2">
              <div class="flex items-center">
                <%= avatar_tag comment.creator, class: "mr-2 w-6 h-6 rounded-full", alt: comment.creator.name %>

                <p class="inline-flex flex-col md:flex-row items-start mr-3 text-sm text-foreground">
                  <span class="font-semibold"><%= comment.creator.name %></span>
                  <%= link_to idea_path(comment.idea, anchor: dom_id(comment)), class: "text-sm text-muted-foreground hover:underline md:ml-2", data: { turbo_frame: "_top" } do %>
                    <%= local_datetime_tag comment.created_at, style: :datetime %>
                  <% end %>
                </p>
              </div>
              <%= render Elements::DropdownMenuComponent.new do |dropdown| %>
                <% dropdown.with_trigger(variant: :ghost, size: :icon, class: "text-muted-foreground") do %>
                  <%= lucide_icon("ellipsis") %>
                  <span class="sr-only"><%= t(".comment_settings") %></span>
                <% end %>

                <% if Current.user&.can_administer_comment?(comment) %>
                  <% dropdown.with_item_content(href: edit_idea_comment_path(comment.idea, comment)) do %>
                    <%= t("edit") %>
                  <% end %>
                  <% dropdown.with_item_content(
                    href: idea_comment_path(comment.idea, comment),
                    method: :delete,
                    form: { data: { turbo_confirm: t("are_you_sure") } }
                  ) do %>
                    <%= t("remove") %>
                  <% end %>
                <% end %>

                <% dropdown.with_item_content(href: "#") do %>
                  <%= t("report") %>
                <% end %>
              <% end %>
            </div>
            <div class="text-muted-foreground" data-controller="syntax-highlight">
              <%= comment.body %>
            </div>

            <% if authenticated? %>
              <div class="mt-3" data-controller="comment-reply">
                <button type="button" class="inline-flex items-center gap-1 text-sm text-muted-foreground hover:text-foreground" data-comment-reply-target="button" data-action="click->comment-reply#toggle">
                  <%= lucide_icon "reply", class: "h-4 w-4" %>
                  <%= t(".reply") %>
                </button>

                <%= render partial: "comments/reply_form", locals: { parent: comment, comment: Comment.new } %>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div id="<%= dom_id(comment) %>_replies" class="mt-4 ml-8">
        <%= render partial: "comments/reply", collection: comment.replies.ordered, as: :comment %>
      </div>
    <% end %>
  </div>
<% end %>
