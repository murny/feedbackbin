<% content_for(:title) { t(".sign_in") } %>

<div class="container container--centered flex flex-column" style="gap: var(--space-6);">
  <%= render "shared/auth_branding" %>

  <div class="card flex flex-column" style="gap: var(--space-6); padding-block: var(--space-6);">
    <header class="txt-align-center" style="padding-inline: var(--space-6);">
      <h1 class="font-weight-bold txt-x-large"><%= t(".welcome_back") %></h1>
      <p class="txt-subtle txt-small margin-block-start-half">
        <% if Current.account.present? %>
          <%= t(".sign_in_to_participate", account_name: Current.account.name) %>
        <% else %>
          <%= t(".login_with_social") %>
        <% end %>
      </p>
    </header>

    <div class="grid" style="padding-inline: var(--space-6); gap: var(--space-6);">
      <%= render "oauth_providers" %>

      <div class="text-divider txt-small txt-subtle"><%= t(".or_continue_with") %></div>

      <div data-controller="tabs email-sync" data-tabs-index-value="<%= @mode == :password ? 1 : 0 %>">
        <% if flash[:alert].present? %>
          <div class="margin-block-end border border-radius txt-align-center txt-small txt-negative" style="padding: var(--space-3) var(--space-4); border-color: var(--color-destructive); background-color: oklch(from var(--color-destructive) l c h / 10%);" role="alert">
            <%= flash[:alert] %>
          </div>
          <% flash.delete(:alert) %>
        <% end %>

        <%# Shared email field (outside panels) %>
        <div class="grid margin-block-end" style="gap: var(--space-3);">
          <%= label_tag :email_address, t(".email"), class: "txt-small font-weight-medium" %>
          <%= email_field_tag :email_address, params[:email_address],
                required: true,
                autofocus: true,
                autocomplete: "email",
                placeholder: t(".email_address_placeholder"),
                data: { email_sync_target: "source" } %>
        </div>

        <%# Magic Link Panel (index 0, shown by default) %>
        <div data-tabs-target="panel" <%= 'class="display-none"' if @mode == :password %>>
          <%= form_with url: session_magic_link_requests_path, data: { action: "submit->email-sync#sync" } do |form| %>
            <%= form.hidden_field :email_address, data: { email_sync_target: "destination" } %>
            <%= form.submit t(".send_magic_link"), class: "btn full-width" %>
          <% end %>

          <p class="txt-align-center txt-small margin-block-start">
            <%= link_to t(".or_sign_in_with_password"), "#",
                  data: { tabs_target: "tab", action: "tabs#change", index: 1 },
                  class: "txt-underline" %>
          </p>
        </div>

        <%# Password Panel (index 1, hidden by default) %>
        <div data-tabs-target="panel" <%= 'class="display-none"' unless @mode == :password %>>
          <%= form_with url: session_path, data: { action: "submit->email-sync#sync" } do |form| %>
            <%= form.hidden_field :email_address, data: { email_sync_target: "destination" } %>

            <div class="grid margin-block-end" style="gap: var(--space-3);">
              <div class="flex align-center">
                <%= form.label :password, t(".password"), class: "txt-small font-weight-medium" %>
                <%= link_to t(".forgot_your_password"), new_users_password_reset_path,
                      class: "margin-inline-start-auto txt-small txt-underline" %>
              </div>
              <%= form.password_field :password,
                    required: true,
                    autocomplete: "current-password",
                    placeholder: t(".password_placeholder"),
                    minlength: Identity::MIN_PASSWORD_LENGTH,
                    maxlength: Identity::MAX_PASSWORD_LENGTH %>
            </div>

            <%= form.submit t(".sign_in"), class: "btn full-width" %>
          <% end %>

          <p class="txt-align-center txt-small margin-block-start">
            <%= link_to t(".or_use_magic_link"), "#",
                  data: { tabs_target: "tab", action: "tabs#change", index: 0 },
                  class: "txt-underline" %>
          </p>
        </div>
      </div>

      <% if Current.account.present? %>
        <p class="txt-align-center txt-small">
          <%= t(".need_an_account") %>
          <%= link_to t(".sign_up"), users_sign_up_path, class: "txt-underline" %>
        </p>
      <% elsif Account.accepting_signups? %>
        <p class="txt-align-center txt-small">
          <%= t(".need_an_account") %>
          <%= link_to t(".sign_up"), signup_path(script_name: nil), class: "txt-underline" %>
        </p>
      <% end %>
    </div>
  </div>

  <p class="txt-subtle txt-align-center txt-x-small txt-balance">
    <%= t(".terms_agreement_html",
          terms_link: link_to(t(".terms_of_service"), terms_path(script_name: nil), class: "txt-underline"),
          privacy_link: link_to(t(".privacy_policy"), privacy_path(script_name: nil), class: "txt-underline")) %>
  </p>
</div>
