<%= content_for :title, @post.title %>
<%= turbo_stream_from @post %>

<section class="container mx-auto px-4 sm:px-6 mt-6 md:mt-10">
  <div class="max-w-5xl mx-auto space-y-6">
    <div>
      <%= link_to posts_path, class: "inline-flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground" do %>
        <%= lucide_icon "chevron-left", class: "h-4 w-4" %>
        <span><%= t(".back_to_feedback") %></span>
      <% end %>
    </div>

    <%= render Ui::CardComponent.new do |c| %>
      <% c.with_body(class: "p-4 md:p-6 lg:p-8") do %>
        <div class="flex items-start gap-3 md:gap-4">
        <div class="pt-1">
          <%= render partial: "likes/like_button", locals: { likeable: @post } %>
        </div>
        <div class="grow">
          <div class="flex items-center justify-between gap-2 mb-2">
            <div class="flex items-center flex-wrap gap-2">
            <% if @post.category %>
                <%= render Ui::BadgeComponent.new(
                  variant: :outline,
                  class: "gap-1.5 text-muted-foreground bg-muted/30 border-border"
                ) do %>
                  <span class="w-2 h-2 rounded-full flex-shrink-0" style="background-color: <%= @post.category.color %>;"></span>
                  <span><%= @post.category.name %></span>
                <% end %>
              <% end %>

              <span id="post-pinned-badge">
                <% if @post.pinned? %>
                  <%= render Ui::BadgeComponent.new(variant: :secondary) do %>
                    <%= lucide_icon "map-pin" %>
                    <%= t(".pinned") %>
                  <% end %>
                <% end %>
              </span>
            </div>

            <div class="flex items-center gap-2">
              <%= render "posts/status_badge", post: @post %>

              <% if policy(@post).pin? || policy(@post).edit? || policy(@post).destroy? %>
                <%= render Ui::DropdownMenuComponent.new do |dropdown| %>
                  <% dropdown.with_trigger do %>
                    <%= render Ui::ButtonComponent.new(variant: :ghost, size: :icon, class: "text-muted-foreground") do %>
                      <%= lucide_icon("ellipsis") %>
                    <% end %>
                  <% end %>

                  <% if policy(@post).edit? %>
                    <% dropdown.with_item_content(href: edit_post_path(@post)) do %>
                      <%= t("edit") %>
                    <% end %>
                  <% end %>

                  <% if policy(@post).pin? %>
                    <% if @post.pinned? %>
                      <% dropdown.with_item_content(
                        id: "post-pin-button",
                        href: post_pin_path(@post),
                        method: :delete
                      ) do %>
                        <%= t(".unpin") %>
                      <% end %>
                    <% else %>
                      <% dropdown.with_item_content(
                        id: "post-pin-button",
                        href: post_pin_path(@post),
                        method: :post
                      ) do %>
                        <%= t(".pin") %>
                      <% end %>
                    <% end %>
                  <% end %>

                  <% if policy(@post).destroy? %>
                    <% dropdown.with_item_separator %>
                    <% dropdown.with_item_content(
                      href: @post,
                      method: :delete,
                      form: { data: { turbo_confirm: t("are_you_sure") } },
                      class: "text-destructive"
                    ) do %>
                      <%= t("delete") %>
                    <% end %>
                  <% end %>
                <% end %>
              <% end %>
            </div>
          </div>

          <h1 class="text-2xl sm:text-3xl font-bold tracking-tight mb-2"><%= @post.title %></h1>

          <div class="flex items-center gap-2 text-sm mb-6">
            <%= avatar_tag @post.author, class: "rounded-full w-8 h-8" %>
            <%= link_to @post.author.name, @post.author, class: "font-medium hover:underline" %>
            <%= lucide_icon "dot" %>
            <%= time_ago_with_tooltip @post.created_at %>
          </div>

          <div class="prose max-w-none">
            <%= @post.body %>
          </div>

          <!-- Bottom: user actions -->
          <div class="mt-6 flex flex-wrap items-center gap-2">
            <%= render Ui::ButtonComponent.new(variant: :outline) do %>
              <%= lucide_icon "eye" %>
              <%= t(".watch") %>
            <% end %>
            <%= render Ui::ButtonComponent.new(variant: :outline) do %>
              <%= lucide_icon "share" %>
              <%= t(".share") %>
            <% end %>
          </div>
        </div>
        </div>
      <% end %>
    <% end %>

    <%= render partial: "comments/comments", locals: {
      comment: @comment,
      post: @post,
      top_level_comments: @top_level_comments
    } %>
  </div>
</section>
